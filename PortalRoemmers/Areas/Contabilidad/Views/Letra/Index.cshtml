@model List<PortalRoemmers.Areas.Contabilidad.Models.Letra.LetraModels>
@using PortalRoemmers.Helpers
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section css {
    @Styles.Render("~/Content/sweetalert_CSS")
    <link href="~/Content/plugins/bower_components/footable/css/footable.core.css" rel="stylesheet" />
}
<!--Cambiar Estado-->
<div id="responsive-modal-Estado" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h2 class="modal-title">Cambiar Estado </h2>
            </div>
            <div class="modal-body">
                <div id='successModal' class='alert alert-success hidden'></div>
                <div id='dangerModal' class='alert alert-danger hidden'></div>
                <div class="form-group">
                    <h4 style="font-size:large;text-align:center;">
                        Letra N° <label id="idCodLet" class="control-label" style="font-size:large;text-align:center;"></label>
                        <input id="idLet" name="idLet" type="hidden">
                    </h4> <br>
                </div>
                <div class="form-group">
                    <label for="idEstadoAct" class="control-label">Estado Actual:</label>
                    <input id="state" name="state" type="hidden">
                    <label id="idEstadoAct" class="form-control" style="text-align:left;"></label>
                </div>
                <div class="form-group">
                    <label class="control-label">Estado a Cambiar :<spam style="color: red;">*</spam></label>
                    @Html.DropDownList("idEst", (SelectList)ViewBag.Estados, "Seleccionar....", htmlAttributes: new { @class = "form-control" })
                </div>
                <div class="form-group">
                    <label for="obs" class="control-label">Observación:</label>
                    <textarea id="obs" rows=5 class="form-control form-control-line" style="text-align:left;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-danger waves-effect waves-light" onclick="modificarEstado();">Guardar</button>
            </div>
        </div>
    </div>
</div>
<!--Cambiar Estado-->
<div class="panel panel-default">
    <div class="panel-heading box-title m-b-0"><h2>Mantenimiento de Letra</h2></div>
    <div class="panel-body">
        <div class="form-group">
            @{ string v = ""; try { v = TempData["mensaje"].ToString(); } catch { }}
            @(new HtmlString(v))
        </div>
        <div class="row show-grid">
            @Html.ActionLink("Crear Letra", "Registrar", "Letra", new { Area = "Contabilidad" }, new { @Class = "btn btn-info btn-rounded btn-outline waves-effect waves-light m-r-10" })
            @Html.ActionLink("Exportar Letras", "ExporLetras", "Letra", new { Area = "Contabilidad" }, new { @Class = "btn btn-info btn-rounded btn-outline waves-effect waves-light m-r-10" })
        </div>
        <div class="row">
            <div class="col-sm-12">
                <div class="table-responsive">
                    <div class="right-page-header">
                        <div class="pull-right">
                            <input type="text" id="demo-input-search2" placeholder="Buscar letra" class="form-control">
                        </div>
                    </div>
                    <div class="clearfix"></div>
                    <div class="scrollable">
                        <div class="table-responsive">
                            <table  class="table m-t-30 table-hover contact-list" data-page-size="10">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th class="hidden"></th>
                                        <th>CODIGO</th>
                                        <th>REFERENCIA</th>
                                        <th>CLIENTE</th>
                                        <th>FECHA GIRO</th>
                                        <th>FECHA VENC.</th>
                                        <th>IMPORTE</th>
                                        <th>ESTADO</th>
                                    </tr>
                                </thead>
                                <tbody>
                                @{foreach (var item in Model)
                                    {
                                        <tr>
                                            <td>
                                                <!--<a href="@Url.Action("Imprimir", "Letra", new {Area="Contabilidad",html = false,idLet=item.idLetra })" data-toggle="tooltip" title="Imprimir"> <i class="fa fa-print text-inverse m-r-10"></i> </a>-->
                                                <a data-toggle="tooltip" title="Imprimir" id="sa-params"><i class="fa fa-print text-inverse m-r-10"></i></a>
                                                <a href="@MyExtensions.ActionUrl("Modificar", "Letra", new { Area = "Contabilidad", id = item.idLetra })" data-toggle="tooltip" title="Modificar"> <i class="fa fa-pencil text-inverse m-r-10"></i> </a>
                                                @{
                                                    //Estado
                                                    var cambio = item.idLetra + "|" + item.codLetra + "|" + item.idEst + "|" + item.estado.nomEst + "|";
                                                }
                                                <a href="#responsive-modal-Estado" id="sa-estado" data-toggle="modal" title="Cambiar Estado" class="cambiar-estado m-r-12" data-detcamb="@cambio"><i class="mdi mdi-etsy"></i></a>
                                            </td>
                                            <td class="hidden">@item.idLetra</td>
                                            <td>@item.codLetra</td>
                                            <td>@item.refLetra</td>
                                            <td>@item.aceptante.nomAceptante</td>
                                            <td>@item.fchGiroLet.ToString("dd/MM/yyyy")</td>
                                            <td>@item.fchVencLet.ToString("dd/MM/yyyy")</td>
                                            <td>@item.moneda.simbMon @item.impLetra</td>
                                            <td><span class="label label-info" style="font-size: 100%;">@item.estado.nomEst</span></td>
                                        </tr>
                                    }
                                    }
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="8">
                                                <div class="text-left">
                                                    <ul class="pagination"> </ul>
                                                </div>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="panel-footer"></div>
    </div>
    @section scripts
    {
        @Scripts.Render("~/Bundles/sweetalert_JS")
        <script src="~/Content/plugins/bower_components/footable/js/footable.all.min.js"></script>
        <script src="~/Scripts/js/footable-init.js"></script>
        <script src="~/Areas/Sistemas/Scripts/Sistemas.js"></script>
        <script>
            //-----------------------------------------------------
            $(document).ready(function () {
                $('table tbody tr a#sa-params').click(function () {
                    var idLetra = $(this).parent().parents('tr').find('td').eq(1).text();
                    swal({
                        title: "¿Desea imprimir con firma?",
                        text: "Debe elegir si desea que la letra \n figure con firma o no.",
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#DD6B55",
                        confirmButtonText: "Sí, con firma!",
                        cancelButtonText: "No, sin firma!",
                        closeOnConfirm: false,
                        closeOnCancel: false
                    }, function (isConfirm) {
                            if (isConfirm) {
                                url = "/Contabilidad/Letra/Imprimir?idLet=" + idLetra + "&fir=" + true;
                                window.open(url);
                                swal("Impreso con Firma!", "Tu letra ha sido impresa con firma.", "success");
                                block();
                                //location.reload();
                        } else {
                                url = "/Contabilidad/Letra/Imprimir?idLet=" + idLetra + "&fir=" + false;
                                window.open(url);
                                swal("Impreso sin Firma!", "Tu letra ha sido impresa sin firma.", "success");
                                block();
                                //location.reload();
                        }
                    });
                });
            });
            //-----------------------------------------------------
            $(document).on("click", ".cambiar-estado", function () {
                //armo la tabla firma
                //--------------------
                var cam = $(this).data('detcamb');
                console.log(cam);
                var id = cam.split("|")[0];
                var cod = cam.split("|")[1];
                var e = cam.split("|")[2];
                var state = cam.split("|")[3];
                //--------------------
                $("#idEstadoAct").text(state);
                $("#idCodLet").text(cod);
                $("#state").text(e);
                $("#idLet").text(id);
                //--------------------
            });
            function modificarEstado() {
                var letra = $("#idLet").text();
                var idNewEst = $("#idEst").val();
                var idOldEst = $("#state").text();
                var observacion = $("#obs").val();

                let url = "/Contabilidad/Letra/modificarEstado?let=" + letra + "&idNewEst=" + idNewEst + "&idOldEst=" + idOldEst + "&obs=" + observacion;
                $.ajax({
                    type: 'POST',
                    url: url,
                    processData: true,
                    success: function (data) {
                        if (data) {
                            //$('#responsive-modal-Estado').modal('hide');
                            $("div #successModal").removeClass('hidden');
                            $("div #successModal").text('Se cambio el estado de  la solicitud');
                            setTimeout(function () { $("div #successModal").fadeOut(2500).fadeIn(2500).fadeOut(2000).fadeIn(2000).fadeOut(500) }, 500);
                            setTimeout(function () { $("div #successModal").addClass('hidden'); }, 3000);
                            //block();
                            location.reload();
                        }
                        else {
                            $("div #dangerModal").removeClass('hidden');
                            $("div #dangerModal").text('No se efectuo el cambio de estado, revise el estado Actual.');
                            setTimeout(function () { $("div #dangerModal").fadeOut(2000).fadeIn(2000).fadeOut(1500).fadeIn(1500).fadeOut(500) }, 500);
                            setTimeout(function () { $("div #dangerModal").addClass('hidden'); }, 4000);
                        }
                    },
                    error: function (xhr) {
                        console.log(' Error:  >>>> ' + JSON.stringify(xhr));
                    }
                });
            };
        </script>
    }
