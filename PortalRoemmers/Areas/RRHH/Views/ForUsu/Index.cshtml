@model List<PortalRoemmers.Areas.RRHH.Models.Formulario.Form_Usu_Models>
@using PortalRoemmers.Helpers
@using PortalRoemmers.Security
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section css {
    @Styles.Render("~/Content/tablaExport_CSS")
}

<!--Reporte de fichas-->
<div id="responsive-modal-formularios" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="frmReporte" enctype="multipart/form-data" method="post">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h2 class="modal-title">Generar Reporte</h2>
                </div>
                <div class="modal-body">

                    <div id='success' class='alert alert-success hidden'></div>
                    <div id='danger' class='alert alert-danger hidden'></div>
                    <div class="form-horizontal form-material">
                        <div class="form-group">
                            <label class="col-md-12">Formulario</label>
                            <div class="col-md-12">
                                @Html.DropDownList("idForR", (SelectList)ViewBag.idFor, "Seleccionar Formulario", htmlAttributes: new { @class = "form-control form-control-line" })
                            </div>
                        </div>
                    </div>
                    <div class="form-horizontal form-material">
                        <div class="form-group">
                            <label class="col-md-12">Fecha</label>
                            <div class="col-md-12">
                                <select id="idDia" class="form-control form-control-line" name="idDia"></select>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button class="btn btn-danger waves-effect waves-light" type="submit">Importar</button>
                    <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">Cerrar</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!--Reporte de fichas-->

<div class="panel panel-default">
    <div class="panel-heading box-title m-b-0"><h2>Usuarios sin confirmar formulario</h2></div>
    <div class="panel-body">
        <section id="wrapper" class="block1">
            <div id='danger' class='alert alert-danger hidden'></div>
            <div id='success' class='alert alert-success hidden'></div>
            <div class="row">
                @using (Html.BeginForm("Index", "ForUsu", new { menuArea = SessionPersister.ActiveMenu, menuVista = SessionPersister.ActiveVista }, FormMethod.Post, new { @class = "form-horizontal form-material" }))
                {
                    <div class="row show-grid">
                        <div class="col-xs-12">
                            <div class="col-md-6 col-md-offset-3">
                                <div class="form-group">
                                    <div class="col-md-12">
                                        <div class="col-md-7">
                                            @Html.DropDownList("idFor", (SelectList)ViewBag.idFor, "Seleccionar Formulario", htmlAttributes: new { @class = "form-control form-control-line" })
                                        </div>
                                        <div class="col-md-3">
                                            @Html.DropDownList("Value", (SelectList)ViewBag.completo, htmlAttributes: new { @class = "form-control form-control-line" })
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn waves-effect waves-light btn-info">
                                                <i class="fa fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <div id="divAproba" class="row show-grid">
                    <div class="col-xs-12">
                        <div class="col-lg-6 col-sm-6 col-xs-12">
                            <a class="fcbtn btn btn-info btn-outline btn-1d btn-lg btn-block" onclick="enviarCorreo()"><i class="mdi mdi-email-outline"></i>   Enviar Correo</a>
                        </div>
                        <div class="col-lg-6 col-sm-6 col-xs-12">
                            <a data-toggle="modal" class="fcbtn btn btn-success btn-outline btn-1d btn-lg btn-block" href="#responsive-modal-formularios"><i class="fa fa-print"></i>   Reportes Fichas</a>
                        </div>
                    </div>
                </div>

                <div class="col-sm-12">
                    <div class="table-responsive">
                        <div class="table-responsive">
                            <table id="example23" class="display nowrap" cellspacing="0" width="100%">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="chkParent" /></th>
                                        <th>FORMULARIO</th>
                                        <th>USUARIO</th>
                                        <th>CORREO</th>
                                        <th>DNI</th>
                                        <th>CELULAR</th>
                                    </tr>
                                </thead>
                                <tfoot>
                                    <tr>
                                        <th></th>
                                        <th>FORMULARIO</th>
                                        <th>USUARIO</th>
                                        <th>CORREO</th>
                                        <th>DNI</th>
                                        <th>CELULAR</th>
                                    </tr>
                                </tfoot>
                                <tbody>
                                    @{foreach (var item in Model)
                                        {
                                            <tr>
                                                <td class="jsgrid-align-center">
                                                    @Html.EditorFor(modelItem => item.option)
                                                </td>
                                                <td>
                                                    @item.formularios.nomFor
                                                </td>
                                                <td>
                                                    @item.accounts.empleado.nomComEmp
                                                </td>
                                                <td>
                                                    @item.accounts.email
                                                </td>
                                                <td>
                                                    @item.accounts.empleado.nroDocEmp
                                                </td>
                                                <td>
                                                    @item.accounts.empleado.numCelEmp
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </section>
    </div>

    <div class="panel-footer"></div>
</div>

@section scripts
{
    @Scripts.Render("~/Bundles/tablaExport_JS")
    @Scripts.Render("~/Bundles/bloqueo_JS")
<script>
        $(document).ready(function () {

            $('#example23').DataTable({
                dom: 'Bfrtip'
                , buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
            });

            $('#chkParent').click(function () {
                var isChecked = $(this).prop("checked");
                $('#example23').DataTable().rows().iterator('row', function (context, index) {
                    $(this.row(index).node()).find('td').eq(0).find('input[type="checkbox"]').prop('checked', isChecked);
                });
            });

            $("#idForR").change(function () {
                if ($("#idForR").val() != "") {
                    var RolOptions = {};
                    RolOptions.url = "/ForUsu/cboFechaFicha";
                    RolOptions.type = "POST";
                    RolOptions.data = JSON.stringify({ idForR: $("#idForR").val() });
                    RolOptions.datatype = "json";
                    RolOptions.contentType = "application/json";
                    RolOptions.success = function (data) {
                        $("#idDia").empty();
                        $("#idDia").append($("<option> </option>").val("").html("Seleccionar"));
                        $.each(data, function (i, item) {
                            $("#idDia").append($("<option> </option>").val(item.Value).html(item.Text));
                        });
                        $("#idDia").prop("disabled", false);
                    };
                    RolOptions.error = function () {
                        alert("Error in Getting States!!");
                        $("#idDia").empty();
                        $("#idDia").prop("disabled", true);
                    };
                    $.ajax(RolOptions);

                }
                else {
                    $("#idDia").empty();
                    $("#idDia").prop("disabled", true);
                }
            });

        });

        $("#frmReporte").submit(function (e) {
            var idFor = $("#idForR").val();
            var idDia = $("#idDia").val();
                 $.ajax({
                     url: '@Url.Action("obtenerReporteLlenado", "ForUsu")',
                     dataType: 'json',
                     type: 'POST',
                     data:{
                         idFor: idFor,
                         idDia: idDia
                     },
                     success: function (result) {
                         if (result != "") {
                             url = "/RRHH/ForUsu/Resultado?ruta=" + result;
                             window.open(url);
                             $("div #success").removeClass('hidden');
                             $("div #success").text("Se genero Reporte !!!");
                             setTimeout(function () { $("div #success").fadeOut(5000); $("div #success").fadeIn(5000); }, 2000);
                             setTimeout(function () { $("div #success").addClass('hidden');  return true; }, 8000);
                            
                         } else {
                             $("div #danger").removeClass('hidden');
                             $("div #danger").text('Se genero un error !!!');
                             setTimeout(function () { $("div #danger").fadeOut(5000); $("div #danger").fadeIn(5000); }, 2000);
                             setTimeout(function () { $("div #danger").addClass('hidden'); }, 8000);
                         }
                     },
                     error: function (err) {
                         alert(err.statusText);
                     }
                 });
                return false;
        });


        function enviarCorreo() {
            var existe = false;
            var correos = '';
            $('#example23').DataTable().rows().iterator('row', function (context, index) {
                if ($(this.row(index).node()).find('td').eq(0).find('input:checked').val()) {//capturamos los seleccionados
                    correos += $.trim($(this.row(index).node()).find('td').eq(3).text()) + ";" + $.trim($(this.row(index).node()).find('td').eq(2).text()) + '|';
                    existe = true;
                }
            });
            correos = correos.substr(0, correos.length - 1);
            console.log(correos);

            if (!existe) {
                $("div #danger").removeClass('hidden');
                $("div #danger").text('Debe seleccionar al menos un item');

                setTimeout(function () { $("div #success").fadeOut(5000); $("div #success").fadeIn(5000); }, 2000);
                setTimeout(function () { $("div #success").addClass('hidden'); }, 8000);
                return false;
            } else {
                block();

                let url = "/RRHH/ForUsu/enviarCorreo?correos=" + correos;
                $.ajax({
                    type: 'POST',
                    url: url,
                    processData: true,
                    success: function (data) {
                        if (data) {
                            $("div #success").removeClass('hidden');
                            $("div #success").text('Se realizo el envio de correos');
                            setTimeout(function () { $("div #success").fadeOut(5000); $("div #success").fadeIn(5000); }, 2000);
                            setTimeout(function () { $("div #success").addClass('hidden'); }, 8000);
                            unblock();
                        }
                        else {
                            $("div #danger").removeClass('hidden');
                            $("div #danger").text('Se genero un error');
                            setTimeout(function () { $("div #danger").fadeOut(5000); $("div #danger").fadeIn(5000); }, 2000);
                            setTimeout(function () { $("div #danger").addClass('hidden'); }, 8000);
                            unblock();
                        }
                    },
                    error: function (xhr) {
                        console.log(' Error:  >>>> ' + JSON.stringify(xhr));
                    }
                });
            }


        }

        function block() {
            $('section.block1').block({
                message: '<h4><img src="../../Content/plugins/images/busy.gif" /> Sólo un momento...</h4>'
                , css: {
                    border: '1px solid #fff'
                }
            });
        }
        function unblock() {
            $('section.block1').unblock();
        }

</script>
}